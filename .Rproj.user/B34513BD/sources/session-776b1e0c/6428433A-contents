# Load necessary libraries
library(tidyverse)
library(sf)         # For spatial data handling
library(ggplot2)    # For visualization
library(viridis)    # For colorblind-friendly palettes
library(maps)       # For map data
install.packages("ggrepel")
library(mapdata)    # Additional map data
library(ggrepel)    # For non-overlapping text labels
library(scales)     # For nice formatting

# Aggregate data by state for visualization
# Assuming fbi_data is already loaded
state_summary <- fbi_data %>%
  group_by(state, state_abbr) %>%
  summarise(
    agency_count = n(),
    nibrs_count = sum(is_nibrs, na.rm = TRUE),
    nibrs_percentage = (nibrs_count / agency_count) * 100,
    .groups = "drop"
  ) %>%
  # Create clear labels for the visualization
  mutate(
    state_label = paste0(state_abbr, "\n", round(nibrs_percentage, 0), "%")
  )

# Get state centroids for bubble placement
# Get US states map data
us_states <- map_data("state")

# Convert state names to be consistent with our data (lowercase to match map_data format)
state_summary$state_lower <- tolower(state_summary$state)

# Get centroids of states for placing the bubbles
state_centroids <- us_states %>%
  group_by(region) %>%
  summarise(
    long = mean(range(long)),
    lat = mean(range(lat)),
    .groups = "drop"
  )

# Join our summary with centroids
state_summary <- state_summary %>%
  left_join(state_centroids, by = c("state_lower" = "region"))

# Create enhanced map
ggplot() +
  # Base map with agency concentration (choropleth)
  geom_polygon(
    data = us_states,
    aes(x = long, y = lat, group = group, fill = state_summary$agency_count[match(region, state_summary$state_lower)]),
    color = "white",
    size = 0.2
  ) +
  # Add bubbles for NIBRS percentage
  geom_point(
    data = state_summary,
    aes(x = long, y = lat, size = nibrs_percentage),
    color = "white",
    alpha = 0.7,
    stroke = 1
  ) +
  # Add state labels
  geom_text_repel(
    data = state_summary,
    aes(x = long, y = lat, label = state_label),
    size = 3,
    fontface = "bold",
    color = "black",
    bg.color = "white",
    bg.r = 0.15,
    segment.color = "grey50",
    segment.size = 0.2,
    force = 1
  ) +
  # Add color scale for agency concentration
  scale_fill_viridis(
    option = "plasma",
    name = "Number of Agencies",
    labels = scales::comma,
    direction = -1
  ) +
  # Scale for bubble size (NIBRS percentage)
  scale_size_continuous(
    name = "NIBRS Participation (%)",
    range = c(1, 12),
    breaks = c(25, 50, 75, 100)
  ) +
  # Improve map appearance
  coord_fixed(1.3) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.box = "vertical",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank()
  ) +
  labs(
    title = "Law Enforcement Agency Distribution and NIBRS Participation by State",
    subtitle = "Color intensity shows number of agencies; Circle size represents NIBRS participation percentage",
    caption = "Source: FBI Crime Data API"
  ) +
  # Add guides for better legend
  guides(
    fill = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = 15,
      barheight = 0.5
    ),
    size = guide_legend(
      title.position = "top",
      title.hjust = 0.5,
      override.aes = list(alpha = 0.7)
    )
  )

# Save high resolution version
ggsave("enhanced_agency_nibrs_map.png", width = 14, height = 10, dpi = 300)

# Create an alternative version with a different color scheme if needed
ggplot() +
  # Base map with agency concentration (choropleth)
  geom_polygon(
    data = us_states,
    aes(x = long, y = lat, group = group, fill = state_summary$agency_count[match(region, state_summary$state_lower)]),
    color = "white",
    size = 0.2
  ) +
  # Add bubbles for NIBRS percentage
  geom_point(
    data = state_summary,
    aes(x = long, y = lat, size = nibrs_percentage),
    color = "#FFD700",  # Gold color for bubbles
    alpha = 0.7,
    stroke = 0.5,
    stroke.color = "black"
  ) +
  # Add state labels
  geom_text_repel(
    data = state_summary,
    aes(x = long, y = lat, label = state_label),
    size = 3,
    fontface = "bold",
    color = "black",
    bg.color = "white",
    bg.r = 0.15,
    segment.color = "grey50",
    segment.size = 0.2,
    force = 1
  ) +
  # Add color scale for agency concentration
  scale_fill_gradient2(
    low = "#E0F7FA",   # Light cyan
    mid = "#0277BD",   # Mid blue
    high = "#01579B",  # Dark blue
    midpoint = median(state_summary$agency_count, na.rm = TRUE),
    name = "Number of Agencies",
    labels = scales::comma
  ) +
  # Scale for bubble size (NIBRS percentage)
  scale_size_continuous(
    name = "NIBRS Participation (%)",
    range = c(1, 12),
    breaks = c(25, 50, 75, 100)
  ) +
  # Improve map appearance
  coord_fixed(1.3) +
  theme_dark() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "#1A1A1A"),
    plot.background = element_rect(fill = "#1A1A1A", color = NA),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5, color = "white"),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "white"),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    plot.caption = element_text(color = "white")
  ) +
  labs(
    title = "Law Enforcement Agency Distribution and NIBRS Participation",
    subtitle = "Color intensity: Number of agencies | Circle size: NIBRS participation %",
    caption = "Source: FBI Crime Data API"
  )

# Save alternative version
ggsave("enhanced_agency_nibrs_map_alt.png", width = 14, height = 10, dpi = 300)

# Create a faceted version that shows both agency count and NIBRS percentage separately
# First map - Agency Count
agency_map <- ggplot() +
  geom_polygon(
    data = us_states,
    aes(x = long, y = lat, group = group, fill = state_summary$agency_count[match(region, state_summary$state_lower)]),
    color = "white",
    size = 0.2
  ) +
  geom_text_repel(
    data = state_summary,
    aes(x = long, y = lat, label = state_abbr),
    size = 3,
    fontface = "bold",
    color = "black",
    bg.color = "white",
    bg.r = 0.15
  ) +
  scale_fill_viridis(
    option = "magma",
    name = "Number of Agencies",
    labels = scales::comma
  ) +
  coord_fixed(1.3) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank()
  ) +
  labs(title = "Agency Distribution by State")

# Second map - NIBRS Percentage
nibrs_map <- ggplot() +
  geom_polygon(
    data = us_states,
    aes(x = long, y = lat, group = group, fill = state_summary$nibrs_percentage[match(region, state_summary$state_lower)]),
    color = "white",
    size = 0.2
  ) +
  geom_text_repel(
    data = state_summary,
    aes(x = long, y = lat, label = state_abbr),
    size = 3,
    fontface = "bold",
    color = "black",
    bg.color = "white",
    bg.r = 0.15
  ) +
  scale_fill_viridis(
    option = "viridis",
    name = "NIBRS Participation (%)",
    labels = scales::percent_format(scale = 1)
  ) +
  coord_fixed(1.3) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank()
  ) +
  labs(title = "NIBRS Participation by State")

# Combine both maps using patchwork
library(patchwork)
combined_map <- agency_map + nibrs_map +
  plot_layout(ncol = 2) +
  plot_annotation(
    title = "Law Enforcement Agency Analysis by State",
    subtitle = "Distribution and NIBRS Adoption",
    caption = "Source: FBI Crime Data API",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5)
    )
  )

# Save the combined map
ggsave("side_by_side_maps.png", combined_map, width = 18, height = 8, dpi = 300)