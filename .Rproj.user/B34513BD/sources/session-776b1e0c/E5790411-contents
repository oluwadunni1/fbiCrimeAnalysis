# Load necessary libraries
library(tidyverse)
library(ggplot2)    # For visualization
library(viridis)    # For colorblind-friendly palettes
library(maps)       # For map data
library(scales)     # For nice formatting

# Aggregate data by state for visualization
# Assuming fbi_data is already loaded
state_summary <- fbi_data %>%
  group_by(state, state_abbr) %>%
  summarise(
    agency_count = n(),
    nibrs_count = sum(is_nibrs, na.rm = TRUE),
    nibrs_percentage = (nibrs_count / agency_count) * 100,
    .groups = "drop"
  )

# Convert state names to lowercase to match map_data format
state_summary$state_lower <- tolower(state_summary$state)

# Use map_data for state boundaries instead of sf to avoid geometry issues
states_map <- map_data("state")

# Join our summary with the map data
states_with_data <- states_map %>%
  left_join(state_summary, by = c("region" = "state_lower"))

# Calculate state centroids manually using base map data
# This avoids the sf geometry errors
state_centroids <- states_map %>%
  group_by(region) %>%
  summarise(
    long = mean(range(long)),
    lat = mean(range(lat)),
    .groups = "drop"
  )

# Join centroids with our summary data
state_centers <- state_centroids %>%
  left_join(state_summary, by = c("region" = "state_lower"))

# Create a clean map for Agency Count
agency_map <- ggplot() +
  # Base layer with state boundaries
  geom_polygon(
    data = states_with_data,
    aes(x = long, y = lat, group = group, fill = agency_count),
    color = "white",
    size = 0.2
  ) +
  # Add state abbreviations
  geom_text(
    data = state_centers,
    aes(x = long, y = lat, label = state_abbr),
    size = 2.5,
    fontface = "bold"
  ) +
  # Color scale
  scale_fill_viridis(
    option = "plasma",
    name = "Number of\nAgencies",
    labels = scales::comma,
    direction = -1
  ) +
  # Maintain map proportions
  coord_fixed(1.3) +
  # Clean theme
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5)
  ) +
  labs(
    title = "Law Enforcement Agency Distribution by State",
    subtitle = "Number of agencies reporting to the FBI's UCR Program"
  )

# Save agency count map
ggsave("agency_count_map.png", agency_map, width = 10, height = 6, dpi = 300)

# Create a separate clean map for NIBRS Participation
nibrs_map <- ggplot() +
  # Base layer with state boundaries
  geom_polygon(
    data = states_with_data,
    aes(x = long, y = lat, group = group, fill = nibrs_percentage),
    color = "white",
    size = 0.2
  ) +
  # Add state abbreviations
  geom_text(
    data = state_centers,
    aes(x = long, y = lat, label = state_abbr),
    size = 2.5,
    fontface = "bold"
  ) +
  # Color scale
  scale_fill_viridis(
    option = "viridis",
    name = "NIBRS\nParticipation (%)",
    labels = scales::percent_format(scale = 1),
    limits = c(0, 100)
  ) +
  # Maintain map proportions
  coord_fixed(1.3) +
  # Clean theme
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5)
  ) +
  labs(
    title = "NIBRS Participation Rate by State",
    subtitle = "Percentage of agencies participating in the National Incident-Based Reporting System"
  )

# Save NIBRS participation map
ggsave("nibrs_participation_map.png", nibrs_map, width = 10, height = 6, dpi = 300)

# Create an alternative visualization using small multiples for Top 10 and Bottom 10 states
# For NIBRS participation
top_bottom_nibrs <- state_summary %>%
  arrange(desc(nibrs_percentage)) %>%
  mutate(rank_order = row_number()) %>%
  filter(rank_order <= 10 | rank_order > n() - 10) %>%
  mutate(category = if_else(rank_order <= 10, "Top 10 States", "Bottom 10 States"),
         state_label = paste0(state_abbr, " (", round(nibrs_percentage, 1), "%)"))

# Create bar chart for top and bottom NIBRS participation
nibrs_bar <- ggplot(top_bottom_nibrs, aes(x = reorder(state_label, nibrs_percentage), y = nibrs_percentage, fill = category)) +
  geom_bar(stat = "identity") +
  facet_wrap(~category, scales = "free_y") +
  scale_fill_manual(values = c("Top 10 States" = "#1A85FF", "Bottom 10 States" = "#D41159")) +
  coord_flip() +
  labs(
    title = "NIBRS Participation: Top 10 vs. Bottom 10 States",
    y = "NIBRS Participation Rate (%)",
    x = ""
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 12, face = "bold"),
    axis.title.y = element_blank(),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  )

# Save bar chart
ggsave("nibrs_top_bottom_bars.png", nibrs_bar, width = 10, height = 6, dpi = 300)

# Create a scatter plot showing relationship between agency count and NIBRS participation
library(ggrepel)  # For non-overlapping text labels

scatter_plot <- ggplot(state_summary, aes(x = agency_count, y = nibrs_percentage)) +
  geom_point(aes(size = agency_count), alpha = 0.7, color = "#0072B2") +
  geom_text_repel(
    aes(label = state_abbr),
    size = 3,
    box.padding = 0.5,
    point.padding = 0.3,
    force = 2,
    segment.color = "grey50",
    segment.size = 0.2
  ) +
  scale_size_continuous(range = c(1, 8), guide = "none") +
  scale_x_log10(labels = scales::comma_format()) +
  labs(
    title = "Agency Count vs. NIBRS Participation by State",
    subtitle = "Log scale used for agency count",
    x = "Number of Agencies (log scale)",
    y = "NIBRS Participation Rate (%)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5)
  )

# Save scatter plot
ggsave("agency_nibrs_scatter.png", scatter_plot, width = 8, height = 6, dpi = 300)

# Create a clean bubble map using traditional ggplot instead of sf
bubble_map <- ggplot() +
  # Base map with light coloring
  geom_polygon(
    data = states_map,
    aes(x = long, y = lat, group = group),
    fill = "#F8F8F8",
    color = "gray80",
    size = 0.2
  ) +
  # Add bubbles sized by agency count and colored by NIBRS percentage
  geom_point(
    data = state_centers,
    aes(x = long, y = lat, size = agency_count, color = nibrs_percentage),
    alpha = 0.8
  ) +
  # Add selected labels to avoid clutter
  geom_text_repel(
    data = state_centers %>% 
      filter(agency_count > median(state_centers$agency_count, na.rm = TRUE) | 
               nibrs_percentage > median(state_centers$nibrs_percentage, na.rm = TRUE)),
    aes(x = long, y = lat, label = state_abbr),
    size = 3,
    fontface = "bold",
    box.padding = 0.5,
    point.padding = 0.3,
    min.segment.length = 0,
    segment.color = "grey70",
    segment.size = 0.2
  ) +
  # Color and size scales
  scale_color_viridis(
    option = "viridis",
    name = "NIBRS\nParticipation (%)",
    limits = c(0, 100)
  ) +
  scale_size_continuous(
    name = "Number of\nAgencies",
    range = c(1, 10),
    breaks = c(100, 500, 1000, 1500)
  ) +
  # Maintain map proportions
  coord_fixed(1.3) +
  # Clean theme
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5)
  ) +
  labs(
    title = "Law Enforcement Agencies and NIBRS Participation by State",
    subtitle = "Bubble size: Number of agencies | Bubble color: NIBRS participation rate"
  )

# Save bubble map
ggsave("simplified_bubble_map.png", bubble_map, width = 10, height = 8, dpi = 300)

# Create a choropleth + bubble hybrid map (more controlled labeling)
# This shows NIBRS as color and agency count as bubbles
hybrid_map <- ggplot() +
  # Base map colored by NIBRS percentage
  geom_polygon(
    data = states_with_data,
    aes(x = long, y = lat, group = group, fill = nibrs_percentage),
    color = "white",
    size = 0.2
  ) +
  # Add bubbles for agency count
  geom_point(
    data = state_centers,
    aes(x = long, y = lat, size = agency_count),
    color = "white",
    alpha = 0.7,
    stroke = 0.5
  ) +
  # Add only the most important labels
  geom_text(
    data = state_centers,
    aes(x = long, y = lat, label = state_abbr),
    size = 2.5,
    fontface = "bold",
    color = "black"
  ) +
  # Color scale for NIBRS
  scale_fill_viridis(
    option = "viridis",
    name = "NIBRS\nParticipation (%)",
    limits = c(0, 100)
  ) +
  # Size scale for agency count
  scale_size_continuous(
    name = "Number of\nAgencies",
    range = c(1, 8)
  ) +
  # Maintain map proportions
  coord_fixed(1.3) +
  # Clean theme
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5)
  ) +
  labs(
    title = "Law Enforcement Agency Analysis by State",
    subtitle = "Color: NIBRS participation rate | Bubble size: Number of agencies"
  )

# Save hybrid map
ggsave("hybrid_map.png", hybrid_map, width = 10, height = 7, dpi = 300)